# Создание образа
Для работы бэк-сервера и веб-админки из файла docker-compose.yaml запускается два сервиса\контейнера: server и web-admin.
Для сборки образов созданы соответствующие файлы Dockerfile, каждый из которых описывает 2 стадии:
1. сборка - копирование файлов, установка зависимостей, компилирование
2. выпуск - копирование скомпилированных файлов в окончательный образ

Для сборки образа сервера необходимо:
- настроить параметры по умолчанию в папке gdmn-mob/apps/server/config
- скопировать SSL сертификаты в корневую папку ssl, которая далее будет примонтирована к контейнеру

Для сборки веб-админки необходимо:
- в корне проекта в .env файле указать значения google ключей для капчи, которые будут переданы при сборке в переменные среды через аргументы. А  также указать TAG для образа веб-админки (prod, dev, demo).
- настроить параметры подключения к серверу в библиотеке gdmn-mob/packages/client-config

Важно, порт HTTPS_PORT в сервисе server должен совпадать с портом, указанным в библиотеке client-config.

## Порядок действий
1. Клонируем репозиторий в папку workspace (предварительно выполнить команду sudo -s и после дать права на папку chown -R $USER gdmn-mob):
```
sudo -s
git clone https://github.com/stasgm/gdmn-mob.git
chown -R $USER gdmn-mob
```

2. Заходим в папку gdmn-mob/apps/server/config, создаем файлы dev.ts и prod.ts, копируя dev.ts.sample.
В этих файлах установлены параметры для работы сервера в зависимости от режима. HOST, PORT, HTTPS_PORT и FILES_PATH будут переопределены в docker-compose через переменные среды.

3. В папку gdmn-mob/ssl переносим 3 файла сертификатов.

4. Заходим в папку gdmn-mob/packages/client-config/src, создаем файлы dev.ts и prod.ts, копируя dev.ts.sample.
В этих файлах указаны настройки соединения с сервером для API запросов.

5. В папке gdmn-mob создаем файл .env, копируя .env.dev.sample, и прописываем значения параметров:

**Секретный ключ для капчи**

REACT_APP_SECRET_KEY=

**Ключ сайта для капчи**

REACT_APP_SITE_KEY=

**Метка для названия образа админки**

CLIENT_ENV=dev

**Хост для сервера, если отличается от '0.0.0.0'**

HOST='0.0.0.0'

**Порт, на котором приложение будет запущено для обработки HTTP-запросов**

PORT=3654

**Порт, на котором приложение будет запущено для обработки HTTPS-запросов**

HTTPS_PORT=3655

**Порт, на котором будет запущен веб-интерфейс**

WEB_ADMIN_PORT=3656

Под каждого клинта должен быть сформирован образ админки со своими значениями портов сервера в библиотеке client-config и помечен меткой, который и надо будет указать в .env файле в параметре CLIENT_ENV.

Например, если CLIENT_ENV=dev, то название образа будет web-admin.dev.

6. Из папки gdmn-mob выполняем команду:
```
docker-compose build
```
Если надо сбилдить только образ админки, то можно выполнить команду:
```
docker-compose -f docker-compose.buildAdmin.yaml
```

8. Для проверки запустим контейнеры:
```
docker-compose up
```

В браузере открываем админку: https://server.gdmn.app:<https порт>

Проверка http cервера: http://server.gdmn.app:<http порт>/api/v1/test

Проверка https сервера: https://server.gdmn.app:<https порт>/api/v1/test


# Загрузка образа в Docker hub
```
docker login --username 'userName' --password 'userPassword'
docker-compose push
docker push <имя_пользователя>/<имя_образа>:<тег=latest>
```

# Запуск контейнера из образа
Чтобы запустить контейнер из образа на Docker Hub, выполните следующие шаги:

1. Установите Docker на вашу виртуальную машину Linux или локальный компьютер, если вы работаете на нём.
2. Создайте папку gdmn-mob - это будет наша рабочая папка контейнера.
2. Скопируйте в рабочую папку файл docker-compose.yaml.
3. Если необходим сервер на https, то создайте папку ssl и скопируйте туда SSL сертификаты.
4. Создайте файл .env и укажите там значение переменной CLIENT_ENV, PORT, HTTPS_PORT, WEB_ADMIN_PORT, (HOST - если отличается от '0.0.0.0').

**Метка для названия образа админки - зависит от клиента и его значений настроек сервера в библиотеке client-config**

CLIENT_ENV=dev

**Порт, на котором приложение будет запущено для обработки HTTP-запросов**

PORT=3654

**Порт, на котором приложение будет запущено для обработки HTTPS-запросов**

HTTPS_PORT=3655

**Порт, на котором будет запущен веб-интерфейс**

WEB_ADMIN_PORT=3656

Чтобы Docker Compose загрузил образы из Docker Hub и создал соответствующие контейнеры, выполните следующую команду из директории, содержащей файл docker-compose.yml:
```
docker-compose up
```
Если запуска в фоновом режиме
```
docker-compose up -d
```
Для остановки контейнера
```
docker-compose stop
```
Если надо получить последние версии образов из DockerHub, надо выполнить команду:
```
docker-compose pull
```
И снова запустить контейнер.

Проверьте, что контейнеры успешно запущены, используя команду docker ps. Вы должны увидеть сервисы с именем "server" и "web-admin.dev" со статусом "Up".
```
docker ps
```

Если надо, копируем старую базу в том db.

Для начала определим путь к папке тома:
```
docker volume inspect gdmn-mob_db
```
Если папка с базой лежит в рабочей папке контейнера, то скопируем ее из текущей папки в папку тома (например, /var/lib/gdmn-mob_db):
```
cp -a . /var/lib/gdmn-mob_db
```
Можно скопировать сразу со своего компьютера:
```
scp -r /путь/к/локальной_папке пользователь@удаленный_сервер:/путь/на/удаленном_сервере
```
Если есть трудности с доступом на запись, можно выполнить команду (-R - дать права на все, что внутри папки):
```
sudo chown -R $USER /путь/к/папке
```

## Команды в помощь
sudo docker ps или sudo docker container ls: Показывает список запущенных контейнеров Docker.
sudo docker images: Показывает список доступных образов Docker на вашей системе.
sudo docker rmi 'ид_образа': Удаляет указанный образ Docker.
sudo docker rm 'ид_контейнера': Удаляет указанный контейнер Docker.
sudo docker-compose build: Собирает образы Docker, указанные в файле docker-compose.yml.
sudo docker-compose up: Запускает контейнеры Docker, определенные в файле docker-compose.yml.
sudo docker stop 'имя_контейнера': Останавливает запущенный контейнер Docker.
mc или midnight Commander: Запускает Midnight Commander - файловый менеджер для командной строки.
sudo -s: Переключается в режим суперпользователя (администратора) в командной оболочке.
sudo docker exec 'ид_контейнера' cat 'путь_к_файлу': Показывает содержимое файла внутри контейнера Docker.
sudo docker exec 'ид_контейнера' ls 'путь_к_папке': Показывает список файлов и папок внутри контейнера Docker.
sudo chown -R $USER 'путь_к_папке': Назначает текущему пользователю права владельца указанной папки.
docker volume inspect 'имя_тома': Показывает информацию о заданном томе Docker.
scp -r 'локальная_папка' 'пользователь@удаленный_сервер:путь_на_удаленном_сервере': Копирует файлы и папки с локальной машины на удаленный сервер по SSH.
docker push 'имя_пользователя/имя_образа:тег': Загружает образ Docker в реестр образов.
docker pull 'имя_пользователя/имя_образа:тег': Скачивает образ Docker из реестра образов.
