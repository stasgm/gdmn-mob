# Создание образа
Для работы бэк-сервера и веб-админки из файла docker-compose.build.yaml формируется и запускается два сервиса\контейнера: server и web-admin.
Для сборки образов созданы соответствующие файлы Dockerfile, каждый из которых описывает 2 стадии:
1. Сборка - копирование файлов, установка зависимостей, компилирование
2. Выпуск - копирование скомпилированных файлов в окончательный образ

Образ сервера собираем и загружаем на Docker Hub c меткой latest.

Образ админки необходимо создавать под каждого клиента со своими настройками и загружать на Docker Hub с уникальным именем. Для это можно использовать файлы docker-compose.web-admin.http.yaml или docker-compose.web-admin.https.yaml, в зависимости от порта, на котором будет работать сервер.

## Порядок действий
1. Клонируем репозиторий в папку workspace (если необходимо, предварительно можно выполнить команду sudo -s и после дать права на папку chown -R $USER gdmn-mob):
```
git clone https://github.com/stasgm/gdmn-mob.git
```

2. Заходим в папку gdmn-mob/apps/server/config, создаем файлы dev.ts и prod.ts, копируя dev.ts.sample.
В этих файлах установлены параметры для работы сервера в зависимости от режима. PORT, HTTPS_PORT, HOST (если отличен от '0.0.0.0') будут переопределены в docker-compose через переменные среды.

3. Заходим в папку gdmn-mob/packages/client-config/src, создаем файлы dev.ts и prod.ts, копируя dev.ts.sample.
В этих файлах указаны настройки соединения с сервером для API запросов.

4. В папке gdmn-mob создаем файл .env, копируя .env.dev.sample, и прописываем значения параметров.

#### Секретный ключ для капчи

REACT_APP_SECRET_KEY=

#### Ключ сайта для капчи

REACT_APP_SITE_KEY=

#### Метка для названия образа админки

CLIENT_ENV=dev

#### Порт хоста, на котором будет запущен веб-интерфейс
ADMIN_HOST_PORT=3656

#### Порт контейнера, на котором будет запущен веб-интерфейс, 443 или 80
ADMIN_CONTAINER_PORT=443

#### Хост для сервера, если отличается от '0.0.0.0'

HOST='0.0.0.0'

#### Порт, на котором приложение будет запущено для обработки HTTP-запросов

PORT=3654

#### Порт, на котором приложение будет запущено для обработки HTTPS-запросов

HTTPS_PORT=3655

Под каждого клинта должен быть сформирован образ админки со своими значениями портов сервера в библиотеке client-config и помечен меткой, который и надо будет указать в .env файле в параметре CLIENT_ENV.

Например, если CLIENT_ENV=dev, то название образа будет web-admin.dev.

Важно, порт HTTPS_PORT или HTTP_PORT при запуске образа сервера должен совпадать с портом, указанным в библиотеке client-config при формировании образа админки. А также в client-config при формировании образа админки должен быть правильно указан IP сервера, если он отличен от домена server.gdmn.app.

5. Из папки gdmn-mob выполняем команду создания образов:
```
docker-compose -f docker-compose.build.yaml build
```

Для того, чтобы сфорфировать только образ сервера можно выполнить команду:
```
docker-compose -f docker-compose.web-admin.yaml build
```

# Формирование образа для админки клиента с нуля

Если надо сбилдить только образ админки для клиента, то:
1. Клонируем репозиторий в папку workspace (предварительно выполнить команду sudo -s и после дать права на папку chown -R $USER gdmn-mob):
```
sudo -s
git clone https://github.com/stasgm/gdmn-mob.git
chown -R $USER gdmn-mob
```
2. Заходим в папку gdmn-mob/packages/client-config/src, создаем файлы dev.ts и prod.ts, копируя dev.ts.sample.
В этих файлах указаны настройки соединения с сервером для API запросов.

3. В папке gdmn-mob создаем файл .env, копируя .env.dev.sample, и прописываем значения параметров для админки:

#### Секретный ключ для капчи

REACT_APP_SECRET_KEY=

#### Ключ сайта для капчи

REACT_APP_SITE_KEY=

#### Метка для названия образа админки

CLIENT_ENV=dev

#### Порт хоста, на котором будет запущен веб-интерфейс
ADMIN_HOST_PORT=3656

#### Порт контейнера, на котором будет запущен веб-интерфейс, 443 или 80
ADMIN_CONTAINER_PORT=443

4. Из папки gdmn-mob выполняем команду создания образа админки, используя файл docker-compose.web-admin:
```
docker-compose -f docker-compose.web-admin.yaml build
```

# Загрузка образа в Docker hub
```
docker login --username 'userName' --password 'userPassword'
docker-compose push
docker push <имя_пользователя>/<имя_образа>:<тег=latest>
```

# Запуск контейнера из образа
Чтобы запустить контейнер из образа на Docker Hub, выполните следующие шаги:

1. Установите Docker на вашу виртуальную машину Linux или локальный компьютер, если вы работаете на нём.
2. Создайте папку gdmn-mob - это будет наша рабочая папка контейнера.
2. Создайте файл docker-compose.yaml, в него скопируйте текст либо из файла docker-compose.http.yaml, либо из docker-compose.https.yaml, в зависимости от порта, на котором будет работать сервер.
3. Если необходим сервер на https, то создайте папку ssl и скопируйте туда SSL сертификаты.
4. Создайте файл .env и укажите там значения переменных:

##### Метка для названия образа админки

CLIENT_ENV=dev

#### Порт хоста, на котором будет запущен веб-интерфейс
ADMIN_HOST_PORT=3656

#### Порт контейнера, на котором будет запущен веб-интерфейс, 443 или 80
ADMIN_CONTAINER_PORT=443

#### Хост для сервера, если отличается от '0.0.0.0'

HOST='0.0.0.0'

#### Порт, на котором приложение будет запущено для обработки HTTP-запросов

PORT=3654

#### Порт, на котором приложение будет запущено для обработки HTTPS-запросов

HTTPS_PORT=3655

Чтобы Docker Compose загрузил образы из Docker Hub и создал соответствующие контейнеры, выполните следующую команду из директории, содержащей файл docker-compose.yml:
```
docker-compose up
```
Если запуска в фоновом режиме
```
docker-compose up -d
```
Для остановки контейнера
```
docker-compose stop
```
Если надо получить последние версии образов из DockerHub, надо выполнить команду:
```
docker-compose pull
```
И снова запустить контейнер.

Если надо, копируем старую базу в том db.

Для начала определим путь к папке тома:
```
docker volume inspect gdmn-mob_db
```
Если папка с базой лежит в рабочей папке контейнера, то скопируем ее из текущей папки в папку тома (например, /var/lib/gdmn-mob_db):
```
cp -a . /var/lib/gdmn-mob_db
```
Можно скопировать сразу со своего компьютера:
```
scp -r /путь/к/локальной_папке пользователь@удаленный_сервер:/путь/на/удаленном_сервере
```
Если есть трудности с доступом на запись, можно выполнить команду (-R - дать права на все, что внутри папки):
```
sudo chown -R $USER /путь/к/папке
```

Проверьте, что контейнеры успешно запущены, используя команду docker ps. Вы должны увидеть сервисы с именем "server" и "web-admin.dev" со статусом "Up".
```
docker ps
```

В браузере открываем админку: https://server.gdmn.app:<https или http порт>

Проверка http cервера: http://server.gdmn.app:<https или http порт>/api/v1/test


## Команды в помощь
sudo docker ps или sudo docker container ls: Показывает список запущенных контейнеров Docker.

sudo docker images: Показывает список доступных образов Docker на вашей системе.

sudo docker rmi 'ид_образа': Удаляет указанный образ Docker.

sudo docker rm 'ид_контейнера': Удаляет указанный контейнер Docker.

sudo docker-compose build: Собирает образы Docker, указанные в файле docker-compose.yml.

sudo docker-compose up: Запускает контейнеры Docker, определенные в файле docker-compose.yml.

sudo docker stop 'имя_контейнера': Останавливает запущенный контейнер Docker.

mc или midnight Commander: Запускает Midnight Commander - файловый менеджер для командной строки.

sudo -s: Переключается в режим суперпользователя (администратора) в командной оболочке.

sudo docker exec 'ид_контейнера' cat 'путь_к_файлу': Показывает содержимое файла внутри контейнера Docker.

sudo docker exec 'ид_контейнера' ls 'путь_к_папке': Показывает список файлов и папок внутри контейнера Docker.

sudo chown -R $USER 'путь_к_папке': Назначает текущему пользователю права владельца указанной папки.

docker volume inspect 'имя_тома': Показывает информацию о заданном томе Docker.

scp -r 'локальная_папка' 'пользователь@удаленный_сервер:путь_на_удаленном_сервере': Копирует файлы и папки с локальной машины на удаленный сервер по SSH.

docker push 'имя_пользователя/имя_образа:тег': Загружает образ Docker в реестр образов.

docker pull 'имя_пользователя/имя_образа:тег': Скачивает образ Docker из реестра образов.
