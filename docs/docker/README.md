# Создание образа
Для работы бэк-сервера и веб-админки из файла docker-compose.build.yaml формируется и запускается два сервиса\контейнера: server и web-admin.
Для сборки образов созданы соответствующие файлы Dockerfile, каждый из которых описывает 2 стадии:
1. сборка - копирование файлов, установка зависимостей, компилирование
2. выпуск - копирование скомпилированных файлов в окончательный образ

Для сборки образа сервера необходимо:
1. Настроить параметры по умолчанию в папке gdmn-mob/apps/server/config
2. В корне проекта в .env файле указать значения переменных
- PORT - порт, на котором приложение будет запущено для обработки HTTP-запросов
- HTTPS_PORT - порт, на котором приложение будет запущено для обработки HTTPS-запросов
- HOST - хост для сервера (если отличен от '0.0.0.0')

Для сборки веб-админки необходимо:
1. Настроить параметры подключения к серверу в библиотеке gdmn-mob/packages/client-config
2. В корне проекта в .env файле указать значения переменных:
- REACT_APP_SECRET_KEY - секретный ключ для капчи
- REACT_APP_SITE_KEY - ключ сайта для капчи
- WEB_ADMIN_PORT - порт, на котором будет запущен веб-интерфейс
- CLIENT_ENV - метка для названия образа админки (prod, dev, demo).

Важно, порт HTTPS_PORT или HTTP_PORT при запуске образа сервера должен совпадать с портом, указанным в библиотеке client-config при формировании образа админки. А также в client-config при формировании образа админки должен быть правильно указан IP сервера, если он отличен от домена server.gdmn.app.

## Порядок действий
1. Клонируем репозиторий в папку workspace (предварительно выполнить команду sudo -s и после дать права на папку chown -R $USER gdmn-mob):
```
sudo -s
git clone https://github.com/stasgm/gdmn-mob.git
chown -R $USER gdmn-mob
```

2. Заходим в папку gdmn-mob/apps/server/config, создаем файлы dev.ts и prod.ts, копируя dev.ts.sample.
В этих файлах установлены параметры для работы сервера в зависимости от режима. PORT, HTTPS_PORT, HOST (если отличен от '0.0.0.0') будут переопределены в docker-compose через переменные среды.

3. Заходим в папку gdmn-mob/packages/client-config/src, создаем файлы dev.ts и prod.ts, копируя dev.ts.sample.
В этих файлах указаны настройки соединения с сервером для API запросов.

4. В папке gdmn-mob создаем файл .env, копируя .env.dev.sample, и прописываем значения параметров.

### Секретный ключ для капчи

REACT_APP_SECRET_KEY=

### Ключ сайта для капчи

REACT_APP_SITE_KEY=

### Метка для названия образа админки

CLIENT_ENV=dev

### Порт, на котором будет запущен веб-интерфейс

WEB_ADMIN_PORT=3656

### Хост для сервера, если отличается от '0.0.0.0'

HOST='0.0.0.0'

### Порт, на котором приложение будет запущено для обработки HTTP-запросов

PORT=3654

### Порт, на котором приложение будет запущено для обработки HTTPS-запросов

HTTPS_PORT=3655

Под каждого клинта должен быть сформирован образ админки со своими значениями портов сервера в библиотеке client-config и помечен меткой, который и надо будет указать в .env файле в параметре CLIENT_ENV.

Например, если CLIENT_ENV=dev, то название образа будет web-admin.dev.

5. Из папки gdmn-mob выполняем команду создания образа:
```
docker-compose -f docker-compose.build.yaml build
```

6. Для проверки запустим контейнеры:
```
docker-compose up
```

В браузере открываем админку: https://server.gdmn.app:<https порт>

Проверка http cервера: http://server.gdmn.app:<http порт>/api/v1/test

Проверка https сервера: https://server.gdmn.app:<https порт>/api/v1/test

# Формирование образа для админки клиента с нуля

Если надо сбилдить только образ админки для клиента, то:
1. Клонируем репозиторий в папку workspace (предварительно выполнить команду sudo -s и после дать права на папку chown -R $USER gdmn-mob):
```
sudo -s
git clone https://github.com/stasgm/gdmn-mob.git
chown -R $USER gdmn-mob
```
2. Заходим в папку gdmn-mob/packages/client-config/src, создаем файлы dev.ts и prod.ts, копируя dev.ts.sample.
В этих файлах указаны настройки соединения с сервером для API запросов.

3. В папке gdmn-mob создаем файл .env, копируя .env.dev.sample, и прописываем значения параметров для админки:

### Секретный ключ для капчи

REACT_APP_SECRET_KEY=

### Ключ сайта для капчи

REACT_APP_SITE_KEY=

### Метка для названия образа админки

CLIENT_ENV=dev

### Порт, на котором будет запущен веб-интерфейс

WEB_ADMIN_PORT=3656

4. Из папки gdmn-mob выполняем команду создания образа админки, используя файл docker-compose.web-admin:
```
docker-compose -f docker-compose.web-admin.yaml build
```

5. Для проверки запустим контейнер:
```
docker-compose -f docker-compose.web-admin.yaml up
```

# Загрузка образа в Docker hub
```
docker login --username 'userName' --password 'userPassword'
docker-compose push
docker push <имя_пользователя>/<имя_образа>:<тег=latest>
```

# Запуск контейнера из образа
Чтобы запустить контейнер из образа на Docker Hub, выполните следующие шаги:

1. Установите Docker на вашу виртуальную машину Linux или локальный компьютер, если вы работаете на нём.
2. Создайте папку gdmn-mob - это будет наша рабочая папка контейнера.
2. Скопируйте в рабочую папку файл docker-compose.yaml.
3. Если необходим сервер на https, то создайте папку ssl и скопируйте туда SSL сертификаты.
4. Создайте файл .env и укажите там значения переменных:

### Метка для названия образа админки

CLIENT_ENV=dev

### Порт, на котором будет запущен веб-интерфейс

WEB_ADMIN_PORT=3656

### Хост для сервера, если отличается от '0.0.0.0'

HOST='0.0.0.0'

### Порт, на котором приложение будет запущено для обработки HTTP-запросов

PORT=3654

### Порт, на котором приложение будет запущено для обработки HTTPS-запросов

HTTPS_PORT=3655

Чтобы Docker Compose загрузил образы из Docker Hub и создал соответствующие контейнеры, выполните следующую команду из директории, содержащей файл docker-compose.yml:
```
docker-compose up
```
Если запуска в фоновом режиме
```
docker-compose up -d
```
Для остановки контейнера
```
docker-compose stop
```
Если надо получить последние версии образов из DockerHub, надо выполнить команду:
```
docker-compose pull
```
И снова запустить контейнер.

Проверьте, что контейнеры успешно запущены, используя команду docker ps. Вы должны увидеть сервисы с именем "server" и "web-admin.dev" со статусом "Up".
```
docker ps
```

Если надо, копируем старую базу в том db.

Для начала определим путь к папке тома:
```
docker volume inspect gdmn-mob_db
```
Если папка с базой лежит в рабочей папке контейнера, то скопируем ее из текущей папки в папку тома (например, /var/lib/gdmn-mob_db):
```
cp -a . /var/lib/gdmn-mob_db
```
Можно скопировать сразу со своего компьютера:
```
scp -r /путь/к/локальной_папке пользователь@удаленный_сервер:/путь/на/удаленном_сервере
```
Если есть трудности с доступом на запись, можно выполнить команду (-R - дать права на все, что внутри папки):
```
sudo chown -R $USER /путь/к/папке
```

## Команды в помощь
sudo docker ps или sudo docker container ls: Показывает список запущенных контейнеров Docker.

sudo docker images: Показывает список доступных образов Docker на вашей системе.

sudo docker rmi 'ид_образа': Удаляет указанный образ Docker.

sudo docker rm 'ид_контейнера': Удаляет указанный контейнер Docker.

sudo docker-compose build: Собирает образы Docker, указанные в файле docker-compose.yml.

sudo docker-compose up: Запускает контейнеры Docker, определенные в файле docker-compose.yml.

sudo docker stop 'имя_контейнера': Останавливает запущенный контейнер Docker.

mc или midnight Commander: Запускает Midnight Commander - файловый менеджер для командной строки.

sudo -s: Переключается в режим суперпользователя (администратора) в командной оболочке.

sudo docker exec 'ид_контейнера' cat 'путь_к_файлу': Показывает содержимое файла внутри контейнера Docker.

sudo docker exec 'ид_контейнера' ls 'путь_к_папке': Показывает список файлов и папок внутри контейнера Docker.

sudo chown -R $USER 'путь_к_папке': Назначает текущему пользователю права владельца указанной папки.

docker volume inspect 'имя_тома': Показывает информацию о заданном томе Docker.

scp -r 'локальная_папка' 'пользователь@удаленный_сервер:путь_на_удаленном_сервере': Копирует файлы и папки с локальной машины на удаленный сервер по SSH.

docker push 'имя_пользователя/имя_образа:тег': Загружает образ Docker в реестр образов.

docker pull 'имя_пользователя/имя_образа:тег': Скачивает образ Docker из реестра образов.
